<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>图片上传</title>
		<link rel="stylesheet" href="../css/bootstrap-fileinput.css" />
		<link rel="stylesheet" href="../css/bootstrap.min.css" />
		<script type="text/javascript" src="../js/sweetalert-dev.js"></script>
		<link rel="stylesheet" href="../css/sweetalert.css" />
	</head>

	<body>

		<div class="container">
			<div style="width: 100%;height: 100px;background: url(../img/jcs.png) no-repeat center;"></div>
			<div class="page-header" style="text-align: center;">
				<h3>图片上传</h3>
				<form>
					<div class="form-group" id="uploadForm" enctype='multipart/form-data'>
						<div class="h4">图片预览</div>
						<div class="fileinput fileinput-new" data-provides="fileinput" id="exampleInputUpload">
							<div class="fileinput-new thumbnail" style="width: 200px;height: auto;max-height:150px;">
								<img id='picImg' style="width: 100%;height: auto;max-height: 140px;" src="../img/noimage.png" alt="" />
							</div>
							<div id="ss" class="fileinput-preview fileinput-exists thumbnail" style="max-width: 200px; max-height: 150px;"></div>
							<div>
								<span class="btn btn-primary btn-file">
                           		<span class="fileinput-new">选择文件</span>
								<span class="fileinput-exists">换一张</span>
								<input type="file" name="pic1" id="picID" />
								</span>
								<a href="javascript:;" class="btn btn-warning fileinput-exists" data-dismiss="fileinput">移除</a>
							</div>
						</div>
					</div>
					<button type="button" id="uploadSubmit" class="btn btn-info">提交</button>
				</form>
			</div>
		</div>
		<script type="text/javascript" src="../js/httplocation.js"></script>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/bootstrap-fileinput.js"></script>
		<script type="text/javascript">
			$(function() {
				//比较简洁，细节可自行完善
				var local;

				function getLocation() {
					local = httpLocation();
					accessToken = getAccessToken();
				}
				$(function() {
					getLocation();
				});
				$('#uploadSubmit').click(function() {
					var src = $("#ss").find("img").attr("src");
					if(src == null || src == "") {
						swal("请选择图片", "", "warning");
					} else {
						function dataURLtoFile(dataurl, filename) { //将base64转换为文件
							var arr = dataurl.split(','),
								mime = arr[0].match(/:(.*?);/)[1],
								bstr = atob(arr[1]),
								n = bstr.length,
								u8arr = new Uint8Array(n);
							while(n--) {
								u8arr[n] = bstr.charCodeAt(n);
							}
							return new File([u8arr], filename, {
								type: mime
							});
						}
						var data = new FormData();
						if(dataURLtoFile(src, "123.png").size / 1024 > 1025) {
							photoCompress(dataURLtoFile(src, "123.png"), {
								quality: 0.2
							}, function(base64Codes) {
								var bl = dataURLtoFile(base64Codes,"456.png");
								data.append("file", bl);
								data.append("code", getQueryString("c")),
									data.append("teacherId", getQueryString("id"));
								data.append("safeTime", getQueryString("t"));
								$.ajax({
									url: local + '/QUESTIONSREPOSITORY/self/codeSendQuestionPic',
									type: 'POST',
									data: data,
									async: false,
									cache: false,
									contentType: false,
									processData: false,
									success: function(data) {
										console.log(data);
										if(data.msg=="成功"){
											swal("上传成功", "", "success");
											$("#uploadSubmit").hide();
										}else{
											swal("上传失败", "", "error");
										}
									},
									error: function(data) {
										console.log(data.status);
										swal("上传失败", "", "error");
									}
								});
							});
						} else {
							data.append("file", dataURLtoFile(src, "123.png"));
							data.append("code", getQueryString("c")),
							data.append("teacherId", getQueryString("id"));
							data.append("safeTime", getQueryString("t"));
							$.ajax({
								url: local + '/QUESTIONSREPOSITORY/self/codeSendQuestionPic',
								type: 'POST',
								data: data,
								async: false,
								cache: false,
								contentType: false,
								processData: false,
								success: function(data) {
									if(data.msg=="成功"){
										swal("上传成功", "", "success");
										$("#uploadSubmit").hide();
									}
								},
								error: function(data) {
									console.log(data.status);
									swal("上传失败", "", "error");
								}
							});
						}
					}
				});
			});

			function photoCompress(file, w, objDiv) {
				var ready = new FileReader();
				ready.readAsDataURL(file);
				ready.onload = function() {
					var re = this.result;
					canvasDataURL(re, w, objDiv)
				}
			}

			function canvasDataURL(path, obj, callback) {
				var img = new Image();
				img.src = $("#ss").find("img").attr("src");
				img.onload = function() {
					var that = this;
					// 默认按比例压缩
					var w = that.width,
						h = that.height,
						scale = w / h;
					w = obj.width || w;
					h = obj.height || (w / scale);
					var quality = 0.7; // 默认图片质量为0.7
					//生成canvas
					var canvas = document.createElement('canvas');
					var ctx = canvas.getContext('2d');
					// 创建属性节点
					var anw = document.createAttribute("width");
					anw.nodeValue = w;
					var anh = document.createAttribute("height");
					anh.nodeValue = h;
					canvas.setAttributeNode(anw);
					canvas.setAttributeNode(anh);
					ctx.drawImage(that, 0, 0, w, h);
					// 图像质量
					if(obj.quality && obj.quality <= 1 && obj.quality > 0) {
						quality = obj.quality;
					}
					// quality值越小，所绘制出的图像越模糊
					var base64 = canvas.toDataURL('image/jpeg', quality);
					// 回调函数返回base64的值
					callback(base64);
				}
			}

			function getQueryString(name) {
				var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
				var r = window.location.search.substr(1).match(reg);
				if(r != null) {
					return unescape(r[2]);
				}
				return null;
			}
		</script>
	</body>

</html>